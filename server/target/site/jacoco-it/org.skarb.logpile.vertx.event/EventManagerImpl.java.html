<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EventManagerImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.html" class="el_package">org.skarb.logpile.vertx.event</a> &gt; <span class="el_source">EventManagerImpl.java</span></div><h1>EventManagerImpl.java</h1><pre class="source lang-java linenums">package org.skarb.logpile.vertx.event;

import org.skarb.logpile.vertx.EventManager;
import org.vertx.java.core.Handler;
import org.vertx.java.core.Vertx;
import org.vertx.java.core.eventbus.Message;
import org.vertx.java.core.json.JsonArray;
import org.vertx.java.core.json.JsonObject;
import org.vertx.java.core.logging.Logger;
import org.vertx.java.core.logging.impl.LoggerFactory;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * Implementation of ImportManager.
 * User: skarb
 * Date: 03/01/13
 */
<span class="fc" id="L21">public class EventManagerImpl implements EventManager,Handler&lt;Message&lt;JsonArray&gt;&gt; {</span>
    /**
     * Field name for the events Handler.
     */
    static final String FIELD_SERVICES = &quot;services&quot;;
    /**
     * Logger.
     */
<span class="fc" id="L29">    private static final Logger log = LoggerFactory.getLogger(EventManagerImpl.class);</span>
    /**
     * current vertx instance.
     */
    private Vertx vertx;
    /**
     * service register List.
     */
<span class="fc" id="L37">    private List&lt;AbstractEventMessage&gt; serviceList = new ArrayList&lt;&gt;();</span>

    @Override
    public void init(final Vertx vertx, final JsonObject config) {
<span class="fc" id="L41">        this.vertx = vertx;</span>
<span class="fc" id="L42">        final JsonArray array = config.getArray(FIELD_SERVICES);</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        if (array == null) {</span>
<span class="fc" id="L44">            return;</span>
        }
<span class="fc bfc" id="L46" title="All 2 branches covered.">        for (int i = 0; i &lt; array.size(); i++) {</span>

            try {
<span class="fc" id="L49">                final String clazz = array.get(i).toString();</span>
<span class="fc" id="L50">                final AbstractEventMessage abstractEventMessage = (AbstractEventMessage) Class.forName(array.get(i).toString()).newInstance();</span>
<span class="fc" id="L51">                abstractEventMessage.setVertx(vertx);</span>
<span class="fc" id="L52">                vertx.eventBus().registerHandler(clazz, abstractEventMessage);</span>
<span class="fc" id="L53">                serviceList.add(abstractEventMessage);</span>
<span class="fc" id="L54">            } catch (Exception e) {</span>
<span class="fc" id="L55">                log.error(&quot;Error in registering event Handler&quot;, e);</span>
<span class="fc" id="L56">            }</span>
        }

<span class="fc" id="L59">        vertx.eventBus().registerHandler(SERVICE_STATE,this);</span>
<span class="fc" id="L60">    }</span>



    @Override
    public void handle(final Message&lt;JsonArray&gt; message) {
<span class="fc" id="L66">        final JsonArray array = new JsonArray();</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for (final AbstractEventMessage evtMessage : serviceList){</span>
<span class="fc" id="L68">            array.addObject(new JsonObject()</span>
                    .putString(&quot;name&quot;,evtMessage.getClass().getName())
                    .putString(&quot;describe&quot;,evtMessage.describe())
                    .putBoolean(&quot;active&quot;,evtMessage.isActive()));
<span class="fc" id="L72">        }</span>
<span class="fc" id="L73">        message.reply(array);</span>
<span class="fc" id="L74">    }</span>

    @Override
    public void run(final Map&lt;String, String&gt; params) {

<span class="fc" id="L79">        final JsonObject jsonObject = new JsonObject();</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        for (final Map.Entry&lt;String, String&gt; entry : params.entrySet()) {</span>
<span class="fc" id="L81">            jsonObject.putString(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L82">        }</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        for (final AbstractEventMessage adress : serviceList) {</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (adress.isActive()) {</span>
<span class="fc" id="L85">                final String name = adress.getClass().getName();</span>
<span class="fc" id="L86">                vertx.eventBus().send(name, jsonObject, new Handler&lt;Message&lt;JsonObject&gt;&gt;() {</span>
                    @Override
                    public void handle(final Message&lt;JsonObject&gt; message) {
<span class="nc" id="L89">                        log.debug(name + &quot; treatment : &quot; + message.body.getBoolean(AbstractEventMessage.RESULT));</span>
<span class="nc" id="L90">                    }</span>
                });
            }
<span class="fc" id="L93">        }</span>
<span class="fc" id="L94">    }</span>

    /**
     * Getter on serviceList.
     *
     * @return the current instance.
     */
    public List&lt;AbstractEventMessage&gt; getServiceList() {
<span class="fc" id="L102">        return serviceList;</span>
    }

    void setServiceList(List&lt;AbstractEventMessage&gt; serviceList) {
<span class="fc" id="L106">        this.serviceList = serviceList;</span>
<span class="fc" id="L107">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span></div></body></html>