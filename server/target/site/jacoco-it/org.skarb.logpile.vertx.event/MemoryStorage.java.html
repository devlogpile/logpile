<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MemoryStorage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.html" class="el_package">org.skarb.logpile.vertx.event</a> &gt; <span class="el_source">MemoryStorage.java</span></div><h1>MemoryStorage.java</h1><pre class="source lang-java linenums">package org.skarb.logpile.vertx.event;

import org.vertx.java.core.Handler;
import org.vertx.java.core.Vertx;
import org.vertx.java.core.json.JsonArray;
import org.vertx.java.core.json.JsonObject;

import java.util.ArrayList;
import java.util.List;

/**
 * Memory reporter of the events.
 * User: skarb
 * Date: 05/01/13
 */
<span class="fc" id="L16">public class MemoryStorage extends AbstractEventMessage {</span>

    public static final String SERVICE_REFRESH = &quot;logpile.resume&quot;;
    public static final String ERRORS_FIELD = &quot;totalError&quot;;
    public static final String APPLICATIONS_LIST_FIELD = &quot;applications&quot;;
    public static final String APP_NAME_FIELD = &quot;name&quot;;
    public static final String COMPONENTS_LIST_FIELD = &quot;components&quot;;
    public static final String APP_ERRORS_FIELD = &quot;count&quot;;
<span class="fc" id="L24">    final List&lt;ErrorApplication&gt; lastApplications = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L25">    final Handler&lt;Long&gt; handler = new Handler&lt;Long&gt;() {</span>
        @Override
        public void handle(Long event) {
<span class="nc" id="L28">            final JsonArray jsonArray = new JsonArray();</span>

<span class="nc bnc" id="L30" title="All 2 branches missed.">            for (final ErrorApplication ea : lastApplications) {</span>
<span class="nc" id="L31">                jsonArray.addObject(ea.toJson());</span>
<span class="nc" id="L32">            }</span>
<span class="nc" id="L33">            final JsonObject result = new JsonObject().putNumber(ERRORS_FIELD, totalError).putArray(APPLICATIONS_LIST_FIELD, jsonArray);</span>

<span class="nc" id="L35">            getVertx().eventBus().send(SERVICE_REFRESH, result);</span>
<span class="nc" id="L36">        }</span>
    };
<span class="fc" id="L38">    int totalError = 0;</span>

    @Override
    public boolean handle(final Event event) {
<span class="fc" id="L42">        totalError++;</span>

<span class="fc" id="L44">        ErrorApplication errorApplication = null;</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">        for (final ErrorApplication ea : lastApplications) {</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">            if (event.getApplication().equals(ea.applicationName)) {</span>
<span class="fc" id="L47">                errorApplication = ea;</span>
<span class="fc" id="L48">                break;</span>
            }
<span class="fc" id="L50">        }</span>

<span class="fc bfc" id="L52" title="All 2 branches covered.">        if (errorApplication == null) {</span>
<span class="fc" id="L53">            errorApplication = new ErrorApplication();</span>
<span class="fc" id="L54">            errorApplication.applicationName = event.getApplication();</span>
<span class="fc" id="L55">            lastApplications.add(errorApplication);</span>
        }

<span class="fc" id="L58">        errorApplication.add(event.getComponent());</span>


<span class="fc" id="L61">        return true;</span>
    }

    @Override
    public String describe() {
<span class="fc" id="L66">        return &quot;Memorize the last Events for the web console.&quot;;</span>
    }

    @Override
    public void setVertx(final Vertx vertx) {
<span class="fc" id="L71">        super.setVertx(vertx);</span>

<span class="fc" id="L73">        vertx.setPeriodic(5000, handler);</span>
<span class="fc" id="L74">    }</span>

<span class="fc" id="L76">    public static class ErrorApplication {</span>

<span class="fc" id="L78">        public final List&lt;String&gt; lastComponents = new ArrayList&lt;&gt;();</span>
        public String applicationName;
<span class="fc" id="L80">        public int countError = 0;</span>

        public void add(final String component) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (!lastComponents.contains(component)) {</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">                if (lastComponents.size() == 10) {</span>
<span class="fc" id="L85">                    lastComponents.remove(lastComponents.size() - 1);</span>
                }
<span class="fc" id="L87">                lastComponents.add(0, component);</span>
            }
<span class="fc" id="L89">            countError++;</span>
<span class="fc" id="L90">        }</span>

        public JsonObject toJson() {
<span class="fc" id="L93">            final JsonArray components = new JsonArray();</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">            for (final String component : lastComponents) {</span>
<span class="fc" id="L95">                components.addString(component);</span>
<span class="fc" id="L96">            }</span>
<span class="fc" id="L97">            return new JsonObject().putString(APP_NAME_FIELD, applicationName).putArray(COMPONENTS_LIST_FIELD, components)</span>
                    .putNumber(APP_ERRORS_FIELD, countError);
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span></div></body></html>