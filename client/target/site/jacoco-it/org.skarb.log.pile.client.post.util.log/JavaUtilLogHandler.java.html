<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JavaUtilLogHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">client</a> &gt; <a href="index.html" class="el_package">org.skarb.log.pile.client.post.util.log</a> &gt; <span class="el_source">JavaUtilLogHandler.java</span></div><h1>JavaUtilLogHandler.java</h1><pre class="source lang-java linenums">package org.skarb.log.pile.client.post.util.log;

import org.skarb.log.pile.client.event.Event;
import org.skarb.log.pile.client.post.engine.Engine;
import org.skarb.log.pile.client.util.JavaUtilLogData;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Date;
import java.util.logging.*;

class JavaUtilLogHandler extends Handler {
    /**
     * DEcorator for {@link LogManager}
     *
     * @author trashy
     */
    static class MyLogManager {

        private final LogManager decoration;

        private static MyLogManager getInstance() {
<span class="fc" id="L23">            return new MyLogManager(LogManager.getLogManager());</span>
        }

        MyLogManager(final LogManager decoration) {
<span class="fc" id="L27">            super();</span>
<span class="fc" id="L28">            this.decoration = decoration;</span>
<span class="fc" id="L29">        }</span>


        Level getLevelProperty(String name, Level defaultValue) {
<span class="fc" id="L33">            String val = decoration.getProperty(name);</span>
<span class="fc bfc" id="L34" title="All 2 branches covered.">            if (val == null) {</span>
<span class="fc" id="L35">                return defaultValue;</span>
            }
            try {
<span class="fc" id="L38">                return Level.parse(val.trim());</span>
<span class="nc" id="L39">            } catch (Exception ex) {</span>
<span class="nc" id="L40">                return defaultValue;</span>
            }
        }

        @SuppressWarnings(&quot;rawtypes&quot;)
        Filter getFilterProperty(String name, Filter defaultValue) {
<span class="fc" id="L46">            String val = decoration.getProperty(name);</span>
            try {
<span class="fc bfc" id="L48" title="All 2 branches covered.">                if (val != null) {</span>
<span class="fc" id="L49">                    Class clz = ClassLoader.getSystemClassLoader().loadClass(val);</span>
<span class="fc" id="L50">                    return (Filter) clz.newInstance();</span>
                }
<span class="nc" id="L52">            } catch (Exception ex) {</span>
                // We got one of a variety of exceptions in creating the
                // class or creating an instance.
                // Drop through.
<span class="fc" id="L56">            }</span>
            // We got an exception.  Return the defaultValue.
<span class="fc" id="L58">            return defaultValue;</span>
        }

        @SuppressWarnings(&quot;rawtypes&quot;)
        Formatter getFormatterProperty(String name, Formatter defaultValue) {
<span class="fc" id="L63">            String val = decoration.getProperty(name);</span>
            try {
<span class="fc bfc" id="L65" title="All 2 branches covered.">                if (val != null) {</span>
<span class="fc" id="L66">                    Class clz = ClassLoader.getSystemClassLoader().loadClass(val);</span>
<span class="fc" id="L67">                    return (Formatter) clz.newInstance();</span>
                }
<span class="nc" id="L69">            } catch (Exception ex) {</span>
                // We got one of a variety of exceptions in creating the
                // class or creating an instance.
                // Drop through.
<span class="fc" id="L73">            }</span>
            // We got an exception.  Return the defaultValue.
<span class="fc" id="L75">            return defaultValue;</span>
        }


        String getStringProperty(String name, String defaultValue) {
<span class="fc" id="L80">            String val = decoration.getProperty(name);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">            if (val == null) {</span>
<span class="fc" id="L82">                return defaultValue;</span>
            }
<span class="fc" id="L84">            return val.trim();</span>
        }

    }


    /**
     * Method for formatting the stackTrace.
     *
     * @param exception the exception of the stacktrace.
     * @return the stackTrace Value.
     */
    public static String formatStackTrace(final Throwable exception) {
<span class="fc" id="L97">        String throwable = &quot;&quot;;</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (exception != null) {</span>
<span class="fc" id="L99">            final StringWriter sw = new StringWriter();</span>
<span class="fc" id="L100">            final PrintWriter pw = new PrintWriter(sw);</span>
<span class="fc" id="L101">            pw.println();</span>
<span class="fc" id="L102">            exception.printStackTrace(pw);</span>
<span class="fc" id="L103">            pw.close();</span>
<span class="fc" id="L104">            throwable = sw.toString();</span>
        }
<span class="fc" id="L106">        return throwable;</span>
    }

    /**
     * format the service name.
     *
     * @param record the source object.
     * @return the class name or the loggerName.
     */
    private static String formatService(final LogRecord record) {
        String source;
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (record.getSourceClassName() != null) {</span>
<span class="fc" id="L118">            source = record.getSourceClassName();</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            if (record.getSourceMethodName() != null) {</span>
<span class="fc" id="L120">                source += &quot; &quot; + record.getSourceMethodName();</span>
            }
        } else {
<span class="nc" id="L123">            source = record.getLoggerName();</span>
        }
<span class="fc" id="L125">        return source;</span>
    }

<span class="fc" id="L128">    public JavaUtilLogHandler() {</span>
<span class="fc" id="L129">        configure(MyLogManager.getInstance());</span>
<span class="fc" id="L130">    }</span>

    void configure(final MyLogManager manager) {

<span class="fc" id="L134">        String cname = getClass().getName();</span>

<span class="fc" id="L136">        setLevel(manager.getLevelProperty(cname + &quot;.level&quot;, Level.INFO));</span>
<span class="fc" id="L137">        setFilter(manager.getFilterProperty(cname + &quot;.filter&quot;, null));</span>
<span class="fc" id="L138">        setFormatter(manager.getFormatterProperty(cname + &quot;.format&quot;, new SimpleFormatter()));</span>
        try {
<span class="fc" id="L140">            setEncoding(manager.getStringProperty(cname + &quot;.encoding&quot;, null));</span>
<span class="nc" id="L141">        } catch (Exception ex) {</span>
            try {
<span class="nc" id="L143">                setEncoding(null);</span>
<span class="nc" id="L144">            } catch (Exception ex2) {</span>
                // doing a setEncoding with null should always work.
                // assert false;
<span class="nc" id="L147">            }</span>
<span class="fc" id="L148">        }</span>

<span class="fc" id="L150">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public synchronized void publish(LogRecord record) {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (!isLoggable(record)) {</span>
<span class="nc" id="L158">            return;</span>
        }
        try {
<span class="fc" id="L161">            JavaUtilLogData logData = JavaUtilLogData.getInstance();</span>

<span class="fc" id="L163">            final Engine engine = logData.getEngine();</span>
<span class="fc" id="L164">            final Event event = new Event();</span>
<span class="fc" id="L165">            event.setApplication(logData.getApplication());</span>
<span class="fc" id="L166">            event.setDate(new Date(record.getMillis()));</span>
<span class="fc" id="L167">            event.setComponent(formatService(record));</span>
<span class="fc" id="L168">            event.setMessage(getFormatter().formatMessage(record)</span>
            );
<span class="fc" id="L170">            event.setStacktrace(formatStackTrace(record.getThrown()));</span>

<span class="fc" id="L172">            engine.post(event);</span>


<span class="fc" id="L175">        } catch (final Exception e) {</span>
<span class="fc" id="L176">            reportError(&quot;LogPile handler failure&quot;, e, ErrorManager.GENERIC_FAILURE);</span>
<span class="fc" id="L177">        }</span>
<span class="fc" id="L178">    }</span>


    /**
     * Null Implemntation
     */
    @Override
    public void flush() {

<span class="nc" id="L187">    }</span>

    /**
     * Null Implemntation
     */
    @Override
    public void close() throws SecurityException {

<span class="nc" id="L195">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span></div></body></html>