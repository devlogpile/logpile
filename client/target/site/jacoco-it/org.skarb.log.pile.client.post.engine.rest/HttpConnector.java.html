<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HttpConnector.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">client</a> &gt; <a href="index.html" class="el_package">org.skarb.log.pile.client.post.engine.rest</a> &gt; <span class="el_source">HttpConnector.java</span></div><h1>HttpConnector.java</h1><pre class="source lang-java linenums">package org.skarb.log.pile.client.post.engine.rest;

import org.skarb.log.pile.client.util.Joiner;
import org.skarb.log.pile.client.util.LogpileException;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Map;

/**
 * Method to call an url.
 * User: skarb
 * Date: 30/12/12
 * Time: 12:16
 */
<span class="fc" id="L20">public class HttpConnector {</span>

    public static final String CHARSET = &quot;UTF-8&quot;;
    public static final String RESULT_OK = &quot;{\&quot;result\&quot;:true}&quot;;
<span class="fc" id="L24">    private static final Joiner.MapJoiner JOIN_PARAMETERS = Joiner.on('&amp;').withKeyValueSeparator(&quot;=&quot;);</span>

    /**
     * create the query parameters string.
     *
     * @param maps the datas parameters.
     * @return the query or empty string.
     */
    String createParameters(final Map&lt;String, String&gt; maps) {
<span class="fc bfc" id="L33" title="All 2 branches covered.">        if (maps.entrySet().isEmpty()) {</span>
<span class="fc" id="L34">            return &quot;&quot;;</span>
        }
<span class="fc" id="L36">        final String join = JOIN_PARAMETERS.join(maps);</span>
<span class="fc" id="L37">        return &quot;?&quot; + join;</span>
    }

    /**
     * Send the error event by calling an http url.
     *
     * @param url the url to call
     * @param method the method
     * @param maps the parameters
     * @throws Exception
     */
    public void send(final String url, final Method method, final Map&lt;String, String&gt; maps) throws LogpileException {
        try {
<span class="fc" id="L50">            final String params = createParameters(maps);</span>
<span class="fc" id="L51">            final HttpURLConnection urlConnection = urlConnection(url, method, params);</span>
<span class="fc" id="L52">            urlConnection.connect();</span>
<span class="fc" id="L53">            treatResponse(urlConnection);</span>
<span class="fc" id="L54">        } catch (final LogpileException le) {</span>
<span class="fc" id="L55">            throw le;</span>
<span class="fc" id="L56">        } catch (final Exception ex) {</span>
<span class="fc" id="L57">            throw new LogpileException(ex);</span>
<span class="fc" id="L58">        }</span>


<span class="fc" id="L61">    }</span>

    /**
     * treat the response of the http url.
     *
     * @param urlConnection the http object.
     * @throws Exception
     */
    void treatResponse(final HttpURLConnection urlConnection) throws LogpileException {
        try {


<span class="fc" id="L73">            final int status = urlConnection.getResponseCode();</span>


<span class="fc bfc" id="L76" title="All 3 branches covered.">            switch (status) {</span>

                case HttpURLConnection.HTTP_OK:
<span class="fc" id="L79">                    final StringBuilder stringBuilder = new StringBuilder();</span>
<span class="fc" id="L80">                    InputStream inputStream = urlConnection.getInputStream();</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                    if(inputStream != null)</span>
<span class="pc" id="L82">                    try (final BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) {</span>
                        String line;
<span class="fc bfc" id="L84" title="All 2 branches covered.">                        while ((line = bufferedReader.readLine()) != null) {</span>
<span class="fc" id="L85">                            stringBuilder.append(line).append('\n');</span>
                        }
<span class="pc bpc" id="L87" title="6 of 8 branches missed.">                    }</span>

<span class="fc bfc" id="L89" title="All 2 branches covered.">                    if (!RESULT_OK.equals(stringBuilder.toString().trim())) {</span>
<span class="fc" id="L90">                        throw new LogpileException(&quot;Errors in calling service : code HTTP :&quot; + HttpURLConnection.HTTP_OK + &quot; - result : &quot; + stringBuilder);</span>
                    }

                    break;
                case HttpURLConnection.HTTP_BAD_REQUEST:
                case HttpURLConnection.HTTP_INTERNAL_ERROR:
<span class="fc" id="L96">                    final StringBuilder resultError = new StringBuilder();</span>
<span class="fc" id="L97">                    InputStream errorStream = urlConnection.getErrorStream();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">                    if(errorStream != null)</span>
<span class="pc" id="L99">                    try (final BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(errorStream))) {</span>
                        String line;
<span class="fc bfc" id="L101" title="All 2 branches covered.">                        while ((line = bufferedReader.readLine()) != null) {</span>
<span class="fc" id="L102">                            resultError.append(line).append('\n');</span>
                        }
<span class="pc bpc" id="L104" title="6 of 8 branches missed.">                    }</span>
<span class="fc" id="L105">                    throw new LogpileException(resultError.toString());</span>

                default:
<span class="fc" id="L108">                    throw new LogpileException(&quot;Bad status : &quot; + status);</span>
            }
<span class="fc" id="L110">        } catch (final LogpileException le) {</span>
<span class="fc" id="L111">            throw le;</span>
<span class="fc" id="L112">        } catch (final Exception ex) {</span>
<span class="fc" id="L113">            throw new LogpileException(ex);</span>
<span class="fc" id="L114">        }</span>
<span class="fc" id="L115">    }</span>

    HttpURLConnection urlConnection(String url, Method method, String params) throws Exception {
        HttpURLConnection urlConnection;

<span class="pc bpc" id="L120" title="1 of 3 branches missed.">        switch (method) {</span>
            case GET:
<span class="fc" id="L122">                final URL urlGET = new URL(url + params);</span>

<span class="fc" id="L124">                urlConnection = (HttpURLConnection) urlGET.openConnection();</span>
<span class="fc" id="L125">                urlConnection.setRequestProperty(&quot;Accept-Charset&quot;, CHARSET);</span>
<span class="fc" id="L126">                urlConnection.setRequestMethod(Method.GET.toString());</span>
<span class="fc" id="L127">                urlConnection.setDoOutput(false);</span>
<span class="fc" id="L128">                break;</span>
            case POST:
<span class="fc" id="L130">                final URL urlObj = new URL(url);</span>
<span class="fc" id="L131">                urlConnection = (HttpURLConnection) urlObj.openConnection();</span>
<span class="fc" id="L132">                urlConnection.setRequestProperty(&quot;Accept-Charset&quot;, CHARSET);</span>
<span class="fc" id="L133">                urlConnection.setRequestMethod(Method.POST.toString());</span>
<span class="fc" id="L134">                urlConnection.setDoOutput(true);</span>

                //urlConnection.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded;charset=&quot; + CHARSET);
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">                if (!params.isEmpty()) {</span>

<span class="nc" id="L139">                    try (OutputStream output = urlConnection.getOutputStream()) {</span>

<span class="nc" id="L141">                        output.write(params.substring(1).getBytes(CHARSET));</span>
<span class="nc bnc" id="L142" title="All 8 branches missed.">                    }</span>
                }
                break;

            default:
<span class="nc" id="L147">                throw new Exception(&quot;method unknown&quot; + method);</span>

        }
<span class="fc" id="L150">        return urlConnection;</span>
    }

<span class="pc" id="L153">    public static enum Method {</span>
<span class="fc" id="L154">        POST, GET</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.6.201201232323</span></div></body></html>